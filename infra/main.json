{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": { "type": "string", "defaultValue": "[resourceGroup().location]" },
    "siteName": { "type": "string", "defaultValue": "yorkixchange-web" },
    "planName": { "type": "string", "defaultValue": "yorkixchange-asp" },
    "containerRegistryName": { "type": "string", "defaultValue": "yorkixchangeacr" },
    "imageName": { "type": "string", "defaultValue": "yorkixchange:latest" },
    "nextPublicSupabaseUrl": { "type": "string" },
    "nextPublicSupabaseAnonKey": { "type": "string" },
    "nextPublicSiteUrl": { "type": "string" },
    "nextPublicAppEnv": { "type": "string", "defaultValue": "production" },
    "supabaseServiceRoleKey": { "type": "string" }
  },
  "resources": [
    {
      "type": "Microsoft.ContainerRegistry/registries",
      "apiVersion": "2023-01-01-preview",
      "name": "[parameters('containerRegistryName')]",
      "location": "[parameters('location')]",
      "sku": { "name": "Basic" },
      "properties": {
        "adminUserEnabled": true,
        "publicNetworkAccess": "Enabled"
      }
    },
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2023-12-01",
      "name": "[parameters('planName')]",
      "location": "[parameters('location')]",
      "kind": "linux",
      "sku": { "name": "B1", "tier": "Basic" },
      "properties": { "reserved": true }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2023-12-01",
      "name": "[parameters('siteName')]",
      "location": "[parameters('location')]",
      "kind": "app,linux,container",
      "properties": {
        "httpsOnly": true,
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('planName'))]",
        "siteConfig": {
          "linuxFxVersion": "[format('DOCKER|{0}.azurecr.io/{1}', parameters('containerRegistryName'), parameters('imageName'))]",
          "alwaysOn": true,
          "appSettings": [
            { "name": "WEBSITES_ENABLE_APP_SERVICE_STORAGE", "value": "true" },
            { "name": "DOCKER_REGISTRY_SERVER_URL", "value": "[format('https://{0}.azurecr.io', parameters('containerRegistryName'))]" },
            {
              "name": "DOCKER_REGISTRY_SERVER_USERNAME",
              "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-01-01-preview').username]"
            },
            {
              "name": "DOCKER_REGISTRY_SERVER_PASSWORD",
              "value": "[first(listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-01-01-preview').passwords).value]"
            },
            { "name": "NEXT_PUBLIC_SUPABASE_URL", "value": "[parameters('nextPublicSupabaseUrl')]" },
            { "name": "NEXT_PUBLIC_SUPABASE_ANON_KEY", "value": "[parameters('nextPublicSupabaseAnonKey')]" },
            { "name": "NEXT_PUBLIC_SITE_URL", "value": "[parameters('nextPublicSiteUrl')]" },
            { "name": "NEXT_PUBLIC_APP_ENV", "value": "[parameters('nextPublicAppEnv')]" },
            { "name": "SUPABASE_SERVICE_ROLE_KEY", "value": "[parameters('supabaseServiceRoleKey')]" },
            { "name": "PORT", "value": "3000" }
          ]
        }
      }
    }
  ],
  "outputs": {
    "registryName": { "type": "string", "value": "[parameters('containerRegistryName')]" },
    "registryLoginServer": { "type": "string", "value": "[format('{0}.azurecr.io', parameters('containerRegistryName'))]" },
    "webUrl": {
      "type": "string",
      "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('siteName')), '2023-12-01').defaultHostName)]"
    }
  }
}
